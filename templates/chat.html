<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DocQuery AI - Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Hide scrollbar for Chrome, Safari and Opera */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        /* Hide scrollbar for IE, Edge and Firefox */
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        .typing-cursor::after {
            content: 'â–‹';
            display: inline-block;
            vertical-align: bottom;
            animation: blink 1s step-start infinite;
        }
        @keyframes blink { 50% { opacity: 0; } }
    </style>
</head>
<body class="bg-slate-50 h-screen flex flex-col">

    <header class="bg-white border-b border-slate-200 px-6 py-4 flex items-center justify-between shadow-sm flex-none">
        <div class="flex items-center space-x-3">
            <div class="bg-blue-600 p-2 rounded-lg">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path></svg>
            </div>
            <h1 class="text-xl font-bold text-slate-800">DocQuery AI</h1>
        </div>
        <a href="/" class="text-sm text-slate-500 hover:text-blue-600 transition-colors">Upload New File</a>
    </header>

    <div id="chatContainer" class="flex-grow p-6 overflow-y-auto space-y-4 no-scrollbar">
        
        <div class="flex justify-start">
            <div class="bg-white border border-slate-200 rounded-2xl rounded-tl-none py-3 px-4 max-w-[80%] shadow-sm">
                <p class="text-slate-700 text-sm">Hello! Your document has been processed. Ask me anything about it.</p>
            </div>
        </div>

        </div>

    <div class="p-4 bg-white border-t border-slate-200 flex-none">
        <div class="max-w-4xl mx-auto relative">
        

            <form onsubmit="event.preventDefault(); sendMsg();" class="relative flex items-center">
                <input 
                    type="text" 
                    id="userInput" 
                    class="w-full bg-slate-100 border-0 rounded-full py-3.5 pl-5 pr-12 text-slate-800 focus:ring-2 focus:ring-blue-500 focus:bg-white transition-all shadow-inner" 
                    placeholder="Ask a question about your document..." 
                    autocomplete="off"
                >
                <button 
                    type="submit" 
                    id="sendBtn"
                    class="absolute right-2 bg-blue-600 hover:bg-blue-700 text-white p-2 rounded-full transition-colors shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg class="w-5 h-5 transform rotate-90" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                </button>
            </form>
            <p class="text-center text-xs text-slate-400 mt-2">AI can make mistakes. Please verify important information.</p>
        </div>
    </div>

    <script>
        ws = new WebSocket("ws://localhost:8000/ws/chat");
        let currentAibubble = null;
        let isfirstchunk = false;
        ws.onopen = function(event) {
            console.log("Websocket connected")
        };
        ws.onmessage = function(event) {
            const token = event.data
            console.log("AI Response Received: ")
            if (token === "[DONE]") {
                currentAibubble.classList.remove("typing-cursor");
                currentAibubble = null;
            }
            if (token.startsWith("[SOURCES]:")) {
                const sources = token.replace("[SOURCES]:", "").trim(); 
                addstufftoUI(sources, "Sources");
                return;
            }
            if (token.startsWith("[RESPONSE DURATION]:")) {
                const time = token.replace("[RESPONSE DURATION]:", "").trim();
                addstufftoUI(time, "Time taken to generate response");
                return;
            }  
            if (currentAibubble) {
                if (isfirstchunk) {
                    currentAibubble.innerHTML = "";
                    isfirstchunk = false;
                }
                currentAibubble.innerHTML += token;
                const container = document.getElementById("chatContainer");
                container.scrollTop = container.scrollHeight;
                scrolltoBottom();
            }
        };
        function sendMsg() {
            const input = document.getElementById("userInput")
            const message = input.value.trim()
            addMessagetoUI(message, "user")
            currentAibubble = addMessagetoUI("Thinking...", "ai") 
            isfirstchunk = true;
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(message)
            }
            input.value = ""   
            scrolltoBottom();       
        }
        function addMessagetoUI(text, sender) {
            const container = document.getElementById("chatContainer")
            const wrapperDiv = document.createElement("div")
            wrapperDiv.className = sender === "user" ? "flex justify-end": "flex justify-start";
            const bubblediv = document.createElement("div")
            if (sender === "user") {
                bubblediv.className = "bg-blue-600 text-white rounded-2xl rounded-tr-none py-3 px-4 max-w-[80%] shadow-md text-sm";
                bubblediv.innerText = text
                bubblediv.id = "userquery"
            } else {
                bubblediv.className = "bg-white border border-slate-200 text-slate-800 rounded-2xl rounded-tl-none py-3 px-4 max-w-[80%] shadow-sm text-sm typing-cursor leading-relaxed";
                bubblediv.innerHTML = text
                bubblediv.id = "airesponse"
            }
            wrapperDiv.appendChild(bubblediv);
            container.appendChild(wrapperDiv);
            return bubblediv
        }
        function addstufftoUI(stuff, desc) {
            const container = document.getElementById("chatContainer");
            const div = document.createElement("div");
            div.className = "flex justify-start mb-4 ml-2";
            div.innerHTML = `
                <div class="text-xs text-slate-400 bg-slate-100 px-3 py-1 rounded-full border border-slate-200">
                    <strong>${desc}:</strong> ${stuff}
                </div>
            `;
            container.appendChild(div);
            scrolltoBottom();
        }
        function scrolltoBottom() {
            const container = document.getElementById("chattContainer");
            setTimeout(() => {
                container.scrollTop = container.scrollHeight;
            }, 0);
        }

    </script>
</body>
</html>